# SPDX-FileCopyrightText: the secureCodeBox authors
#
# SPDX-License-Identifier: Apache-2.0

name: Move bot PRs to Review
on:
  pull_request:
    types: [opened]
    branches:
      - 'dependabot/**'
      - 'dependencies/upgrading**'


jobs:
  move-bot-pr-to-review:   
    runs-on: ubuntu-22.04
    steps:
      - uses: actions/checkout@v4

      - name: Add bot PR to project
        run: |
          # Get the ID for the field Status 
          # gh project list --owner secureCodeBox
          secureCodeBoxV4ProjectID="PVT_kwDOAg-Nic05GQ"

          # Add item to project
          echo prNodeID=$(gh api graphql -f query="
            mutation {
              addProjectV2ItemById(input: {projectId: \"$secureCodeBoxV4ProjectID\", contentId: \"$PR_ID\"}) {
                item {
                  id
                }
              }
            }" | jq -r '.data.addProjectV2ItemById.item.id') >> $GITHUB_ENV
        env: 
          GH_TOKEN: ${{ secrets.SCB_BOT_USER_TOKEN }} 
          PR_ID: ${{ github.event.pull_request.node_id }}

      - name: Move PR to column To Review
        run: |
          # Get the ID for the field Status 
          # gh project field-list 6 --owner secureCodeBox
          StatusFieldID="PVTSSF_lADOAg-Nic05Gc4AAZuO"

          secureCodeBoxV4ProjectID="PVT_kwDOAg-Nic05GQ"

          # ID for status "To Review"
          ToReviewID="00b0c876"

          prNodeID=${{env.prNodeID}}
          # Move PR to "To Review" status
          gh project item-edit --id ${{ env.prNodeID }} --field-id $StatusFieldID --project-id $secureCodeBoxV4ProjectID --single-select-option-id $ToReviewID
          
          
          # This command gets the IDs for the status options
          #gh api graphql -f query='
          #  query {
          #    organization(login: "secureCodeBox") {
          #      projectV2(number: 6) {
          #        fields(first: 20) {
          #          nodes {
          #            ... on ProjectV2SingleSelectField {
          #              id
          #              name
          #              options {
          #                id
          #                name
          #              }
          #            }
          #          }
          #        }      
          #      }    
          #    }  
          #  }'

          # 
          #  "data": {
          #    "organization": {
          #      "projectV2": {
          #        "fields": {
          #          "nodes": [
          #            {},
          #            {},
          #            {
          #              "id": "PVTSSF_lADOAg-Nic05Gc4AAZuO",
          #              "name": "Status",
          #              "options": [
          #                "organization": {
          #                {
          #                  "id": "fdb7acaa",
          #                  "name": "Backlog"
          #                },
          #                {
          #                  "id": "f75ad846",
          #                  "name": "Todo"
          #                },
          #                {
          #                  "id": "47fc9ee4",
          #                  "name": "In Progress"
          #                },
          #                {
          #                  "id": "00b0c876",
          #                  "name": "To Review"
          #                },
          #                {
          #                  "id": "ea7b630a",
          #                  "name": "Reviewer Approved"
          #                },
          #                {
          #                  "id": "98236657",
          #                  "name": "Done"
          #                }
          #              ]
          #            },
          #            {},
          #            {},
          #            {},
          #            {},
          #            {}
          #          ]
          #        }
          #      }
          #    }
          #  }
          #}
        env:
          GH_TOKEN: ${{ secrets.SCB_BOT_USER_TOKEN }} 